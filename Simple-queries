# A. The clients who had cancelled orders (fields to be extracted: client name, country, city)

SELECT customerName as "Client name", country as Country, city as City
FROM customers c 
JOIN orders o on o.customerNumber = c.customerNumber 
WHERE status = "Cancelled"


# B. Total orders which were not cancelled, split per year and month (fields to be extracted: year, month, orders)

SELECT 
	YEAR(orderDate) as Year,
	MONTH(orderDate) as Month,
	COUNT(orderNumber) as Orders
FROM orders o 
WHERE status != "Cancelled"
GROUP BY YEAR(orderDate), MONTH(orderDate)


# C. The top 3 products for each productline with the highest inventory value (by inventory value we refer to the total value of the cars that are the same -fields to be extracted: productline, productcode, productname, total value)

SELECT productLine, productCode, productName, TotalValue 
FROM
   	(SELECT productLine, productCode, productName, ROUND(SUM(quantityInStock * buyPrice),2) as TotalValue,
                  ROW_NUMBER() OVER (PARTITION BY productLine ORDER BY TotalValue DESC) as country_rank
      FROM products p
      GROUP BY productLine, productName
      ) ranked
WHERE country_rank <= 3
ORDER BY productLine, TotalValue DESC 


# D. A function that receives an employee code and retrieves the city in which the employee works.

DELIMITER //

CREATE FUNCTION check_city_func (emp_code INT)
RETURNS VARCHAR(50) DETERMINISTIC

BEGIN

   DECLARE emp_city VARCHAR(50);
  
   SELECT o.city INTO emp_city 
   FROM employees e
   JOIN offices o 
   ON e.officeCode = o.officeCode 
   WHERE e.employeeNumber = emp_code;
  
   RETURN emp_city;

END; //

DELIMITER ;
